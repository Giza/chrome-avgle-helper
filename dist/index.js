(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f;}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e);},l,l.exports,e,t,n,r);}return n[o].exports;}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s;})({1:[function(require,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});const M3U8_PATTERN=exports.M3U8_PATTERN='*://*.ahcdn.com/*.m3u8';const VIDEO_PAGE_PATTERN=exports.VIDEO_PAGE_PATTERN=/(https|http):\/\/avgle.com\/video\/\d+\//;},{}],2:[function(require,module,exports){"use strict";var _config=require("./config");var _inject_to_player=require("./inject_to_player");var _m3u=require("./m3u8");console.log('Chrome Avgle Helper background script started!');console.log(`Extension id: ${chrome.runtime.id}`);chrome.webRequest.onBeforeRequest.addListener(details=>{if(details.tabId<0)return;console.log(`Captured m3u8 request (method: ${details.method}) from tab(id: ${details.tabId}):`+`\n${details.url}`);chrome.tabs.get(details.tabId,tab=>{console.log(`Tab title: ${tab.title}`);console.log(`Tab URL: ${tab.url}`);if(!tab.url.match(_config.VIDEO_PAGE_PATTERN))return console.log("Ignore this tab!");let xhr=new XMLHttpRequest();xhr.open('GET',details.url);xhr.onload=()=>{if(xhr.readyState!=4||xhr.status!=200){return injectScript(`m3u8 file request failed! `+`(readyState = ${xhr.readyState}; status = ${xhr.status};)\n`+`URL:${details.url}`);}try{let command=(0,_m3u.getDownloadCmdFromM3U8)(xhr.responseText);injectScript(null,command);}catch(ex){injectScript(ex,null);}};xhr.onerror=err=>injectScript(err,null);xhr.send();function injectScript(err,command=null){if(err)if(typeof err!='string')err=`${err.message}\n${err.stack}`;chrome.tabs.executeScript(details.tabId,{code:(0,_inject_to_player.getInjectScript)(err,command)},()=>{console.log('Inject script success!');});}});},{urls:[_config.M3U8_PATTERN]});},{"./config":1,"./inject_to_player":3,"./m3u8":5}],3:[function(require,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});exports.getInjectScript=getInjectScript;var _inject_utils=require('./inject_utils');var _inject_utils2=_interopRequireDefault(_inject_utils);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function getInjectScript(errorStr,commandDisplay){const injectHelperName='chromeAvgleHelper';return`
		${_inject_utils2.default.getInjectCodes(injectHelperName)};
		(${inject2player.toString()})(
			${injectHelperName},
			${JSON.stringify(errorStr)}, 
			${JSON.stringify(commandDisplay)}
		);`;}function inject2player(utilsContext,errorStr,commandDisplay){let videoTitleDOM=document.querySelector('.container .row .col-lg-12 h1');window.alert=null;window.open=null;for(let adIframe of document.querySelectorAll('iframe'))adIframe.parentNode.removeChild(adIframe);for(let video of document.querySelectorAll('a>video'))video.parentNode.removeChild(video);let e=document.querySelector('#blocked-if');e.parentNode.removeChild(e);let addonCommand='';let endCommand='Avgle; // combine video files';for(let node of videoTitleDOM.childNodes){if(node.nodeType==Node.TEXT_NODE){let videoTitle=node.textContent;let carNumber=utilsContext.parseCarNumber(videoTitle);if(carNumber){let carNumDOM=document.createElement('b');carNumDOM.className='text-success';carNumDOM.innerText=carNumber;node.parentNode.insertBefore(carNumDOM,node);addonCommand=`mkdir ${carNumber};\ncd ${carNumber};`;}break;}}let injectDiv=document.createElement('div');injectDiv.className='col-lg-12';if(errorStr){injectDiv.className+=" alert-danger";injectDiv.innerHTML=`
			Get Download Command Failed:
			<pre><code>${errorStr}</code></pre>
		`;}else{injectDiv.innerHTML=`
			Download Command:<br/>
			<pre><code>${addonCommand}\n${commandDisplay}\n${endCommand}</code></pre>
		`;}let injectContainer=videoTitleDOM.parentNode.parentNode;injectContainer.appendChild(injectDiv);for(let script of document.querySelectorAll('script'))script.parentNode.removeChild(script);let asideAd=document.querySelector('#ps32-container').parentNode;let mainRow=asideAd.parentNode;mainRow.removeChild(asideAd);for(let e of mainRow.childNodes)e.className='col-lg-12';}},{"./inject_utils":4}],4:[function(require,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});let exportFunctions={getInjectCodes,parseCarNumber};exports.default=exportFunctions;function getInjectCodes(wrapperName){let result=`window.${wrapperName} = {};`;result+=Object.keys(exportFunctions).map(funcName=>{let funcBody=exportFunctions[funcName].toString();return`${wrapperName}.${funcName} = ${funcBody};`;}).join('');return result;}function parseCarNumber(str=''){const matchers=[[/fc2[\s\-]?ppv[\s\-]?(\d+)/i,match=>`FC2-PPV-${match[1]}`],[/S-Cute\s+(\w+)\s+#(\d+)/i,match=>`S-Cute-${match[1]}-${match[2]}`],[/Heydouga[\-\s]?(\d+)[\-\s]?(\d+)/i,match=>`Heydouga-${match[1]}-${match[2]}`],[/Caribbean[\-\s]?(\d+)[\-\s]?(\d+)/i,match=>`Caribbean-${match[1]}-${match[2]}`],/\w+-\d+/i,[/(\w{8,})[\-_\s](\d{5,})[\-_\s](\d{3,})/,match=>`${match[1]}-${match[2]}-${match[3]}`]];for(let matcher of matchers){if(Array.isArray(matcher)){let result=str.match(matcher[0]);if(result)return matcher[1](result);}else{let result=str.match(matcher);if(result)return result[0];}}return null;}},{}],5:[function(require,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});exports.getDownloadCmdFromM3U8=getDownloadCmdFromM3U8;function getDownloadCmdFromM3U8(m3u8=''){let videos=m3u8.split(/[\n\r]+/).filter(line=>line&&line[0]!='#');let count=videos.length;let lastVideo=videos[count-1];let matcher=new RegExp(`seg-(${count})-([\\w\\-]+)\\.ts$`);let replacer=(_,id,format)=>`seg-{1..${id}}-${format}.ts`;if(!matcher)throw new Error(`Could not match "${matcher.toString()}" from "${lastVideo}"`);return'wget '+lastVideo.replace(matcher,replacer);}},{}]},{},[2]);
//# sourceMappingURL=index.js.map